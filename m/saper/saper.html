<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saper</title>
    <style>
        body {
            user-select: none;
        }

        table {
            border-spacing: 0;
            border: black 1px solid;
            margin: auto;
            white-space: nowrap;
        }

        tr {
            height: 50px;
            padding: 0;
            white-space: nowrap;
        }

        th {
            width: 50px;
            padding: 0;
            border: black 1px solid;
            background-size: 100% 100%;
        }

        #values {
            position: relative;
            text-align: center;
        }

        #valuesButton {
            position: relative;
            top: 20px;
            font-size: 20px;
        }

        #main {
            position: relative;
            top: -200px;
        }
    </style>

</head>
<script>
    let BOARD_WIDTH = 0;
    let BOARD_HEIGHT = 0;
    let NUMBER_OF_MINES = 0;

    const CLEAR_FIELD = 0;
    const MINE = 1;
    const NONE = 0;
    const FLAG = 1;
    const QM = 2;
    const VIEWED = 1;
    const NOT_VIEWED = 0;

    let gameLock = true;
    let gameBoard;
    let startTime;

    let timer;
    let currentTime

    window.onload = () => {
        document.getElementById("valuesButton").onclick = startGame;
    }

    function startGame() {
        let w = getElement("w").value;
        let h = getElement("h").value;
        let mines = getElement("mines").value;

        if (w >= 0 && h >= 0 && mines >= 0 && mines < (w * h)) {
            BOARD_WIDTH = parseInt(w);
            BOARD_HEIGHT = parseInt(h);
            NUMBER_OF_MINES = parseInt(mines);

            startTime = Date.now();

            timer = setInterval(refreshTimer, 1)

            getElement("values").style.top = "-13000px"

            gameBoard = Array.from(Array(BOARD_HEIGHT), () => new Array(BOARD_WIDTH));
            genBoard();

            refreshScore();
        }
    }

    function genBoard() {
        createTableElement();

        genMines();
    }

    function createTableElement() {
        let board = document.getElementById('board');

        for (let i = 0; i < BOARD_HEIGHT; i++) {
            let newTr = document.createElement('tr')
            for (let k = 0; k < BOARD_WIDTH; k++) {
                gameBoard[i][k] = {x: i, y: k, number: 0, type: 0, tag: NONE, view: NOT_VIEWED};
                let newTh = document.createElement('th')
                newTh.id = k + "x" + i;
                newTh.style.backgroundImage = "url(field.png)"

                newTh.onclick = () => onFieldClick(i, k)

                newTh.addEventListener('contextmenu', (ev) => onRightClick(ev, k, i), false);
                newTr.appendChild(newTh)

            }
            board.appendChild(newTr);
        }
    }

    function genMines() {
        for (let c = 0; c < NUMBER_OF_MINES; c++) {
            let toggle = true;
            do {
                let width = drawWidth();
                let height = drawHeight();
                if (gameBoard[height][width].type === CLEAR_FIELD) {
                    gameBoard[height][width].type = MINE;

                    setNumbers();
                    toggle = false;
                }
            } while (toggle)
        }
    }

    function drawWidth() {
        return Math.floor((Math.random() * BOARD_WIDTH));
    }

    function drawHeight() {
        return Math.floor((Math.random() * BOARD_HEIGHT));
    }

    function setNumbers() {
        for (let height = 0; height < BOARD_HEIGHT; height++) {
            for (let width = 0; width < BOARD_WIDTH; width++) {
                let counter = 0;
                for (let x = height - 1; x <= height + 1; x++) {
                    for (let y = width - 1; y <= width + 1; y++) {
                        if (x >= 0 && y >= 0 && x < BOARD_HEIGHT && y < BOARD_WIDTH)
                            if (gameBoard[x][y].type === MINE) {
                                counter++;
                            }
                    }
                }
                gameBoard[height][width].number = counter;
            }
        }
    }

    function onFieldClick(height, width) {
        if (gameLock && gameBoard[height][width].tag === NONE)
            if (gameBoard[height][width].number === CLEAR_FIELD) {
                checkFieldsAround(height, width)
            } else {
                let field = getField(width, height)
                if (gameBoard[height][width].type === MINE) {
                    showBombs();

                    field.style.backgroundImage = "url(bomb.png)";
                    gameLock = false;
                    getElement("msg").innerText = "PRZEGRALES :(, czas: " + currentTime;
                    clearInterval(timer)
                } else {
                    field.style.backgroundImage = "";
                    // if (gameBoard[width][height].number > 0)
                    field.innerHTML = gameBoard[width][height].number;
                    gameBoard[height][width].view = VIEWED;
                }
            }
    }

    function checkFieldsAround(height, width) {
        for (let i = height - 1; i <= height + 1; i++) {
            for (let j = width - 1; j <= width + 1; j++) {
                if (i >= 0 && j >= 0 && i < BOARD_HEIGHT && j < BOARD_WIDTH)
                    if (gameBoard[i][j].view === NOT_VIEWED) {
                        getField(j, i).style.backgroundImage = "";
                        if (gameBoard[i][j].number > 0)
                            getField(j, i).innerHTML = gameBoard[i][j].number;
                        gameBoard[i][j].view = VIEWED;
                        if (gameBoard[i][j].number === 0) {
                            checkFieldsAround(i, j)
                        }
                    }
            }
        }
    }

    function refreshScore() {
        getElement("mines-counter").innerText = "Nieoznaczone bomby: " + sumTagged();
    }

    function onRightClick(ev, x, y) {
        ev.preventDefault();

        if (gameLock && gameBoard[y][x].view === NOT_VIEWED) {
            let field = getField(x, y)
            switch (gameBoard[y][x].tag) {
                case NONE:
                    field.style.backgroundImage = "url(flag.png)";
                    gameBoard[y][x].tag = FLAG
                    break;
                case FLAG:
                    field.style.backgroundImage = "url(qm.png)";
                    gameBoard[y][x].tag = QM;
                    break;
                case QM:
                    field.style.backgroundImage = "url(field.png)";
                    gameBoard[y][x].tag = NONE;
                    break;
            }
            refreshScore();
        }

        if (sumTagged() === 0) {
            gameLock = false;
            getElement("msg").innerText = "WYGRALES!!!!, czas: " + currentTime
            clearInterval(timer)
            showBombs()
        }
    }

    function sumTagged() {
        let counter = 0;
        for (let i = 0; i < BOARD_HEIGHT; i++) {
            for (let k = 0; k < BOARD_WIDTH; k++) {
                if (gameBoard[i][k].tag === FLAG) {
                    counter++;
                }
            }
        }
        return NUMBER_OF_MINES - counter;
    }

    function showBombs() {
        for (let i = 0; i < BOARD_HEIGHT; i++) {
            for (let k = 0; k < BOARD_WIDTH; k++) {
                if (gameBoard[i][k].type === MINE) {
                    getField(k, i).style.backgroundImage = "url(pbomb.png)";
                }
            }
        }
    }

    function refreshTimer() {
        let date = new Date(Date.now() - startTime);
        let ms = date.getMilliseconds();
        if (ms < 100) {
            ms = ms * 10;
        }
        currentTime = date.getMinutes() + ":" + date.getSeconds() + "." + ms;
        getElement("msg").innerText = currentTime;
    }

    function getElement(name) {
        return document.getElementById(name);
    }

    function getField(x, y) {
        return document.getElementById(x + "x" + y);
    }
</script>
<body>
<div id="values">
    <label>
        <h2 style="text-align:center;">Wysokosc:</h2>
        <input id="w" type="number" min="0" value="10">
    </label>
    <label>
        <h2 style="text-align:center;">Szerokosc:</h2>
        <input id="h" type="number" min="0" value="10">
    </label>
    <label>
        <h2 style="text-align:center;">Ilosc bomb:</h2>
        <input id="mines" type="number" min="0" value="15">
    </label>
    <br>
    <button id="valuesButton">Generuj</button>
</div>
<div id="main">
    <h2 id="msg" style="text-align:center;"></h2>
    <table id="board"></table>
    <h2 id="mines-counter" style="text-align:center;"></h2>
    <div id="test"></div>
</div>
</body>
</html>