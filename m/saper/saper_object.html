<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Saper object</title>
    <style>
        body {
            user-select: none;
        }

        table {
            border-spacing: 0;
            border: black 1px solid;
            margin: auto;
            white-space: nowrap;
        }

        tr {
            height: 50px;
            padding: 0;
            white-space: nowrap;
        }

        th {
            width: 50px;
            padding: 0;
            border: black 1px solid;
            background-size: 100% 100%;
        }

        #values {
            position: relative;
            text-align: center;
        }

        #valuesButton {
            position: relative;
            top: 20px;
            font-size: 20px;
        }

        #main {
            position: relative;
            top: -200px;
        }
    </style>
    <script>
        const saper = {
            BOARD_WIDTH: 0,
            BOARD_HEIGHT: 0,
            NUMBER_OF_MINES: 0,

            CLEAR_FIELD: 0,
            MINE: 1,
            NONE: 0,
            FLAG: 1,
            QM: 2,
            VIEWED: 1,
            NOT_VIEWED: 0,

            gameLock: true,
            gameBoard: [[]],
            startTime: Date,
            timer: undefined,
            currentTime: undefined,
            area: 0,

            startGame: () => {
                let w = saper.getElement("w").value;
                let h = saper.getElement("h").value;
                let mines = saper.getElement("mines").value;
                saper.area = (w * h)

                if (w >= 0 && h >= 0 && mines >= 0 && mines < saper.area) {
                    BOARD_WIDTH = parseInt(w);
                    BOARD_HEIGHT = parseInt(h);
                    NUMBER_OF_MINES = parseInt(mines);

                    saper.startTime = Date.now();
                    saper.timer = setInterval(saper.refreshTimer, 1)

                    saper.getElement("values").style.top = "-13000px"

                    gameBoard = Array.from(Array(BOARD_HEIGHT), () => new Array(BOARD_WIDTH));
                    saper.genBoard();
                }
            },
            createTableElement: () => {
                let board = document.getElementById('board');

                for (let h = 0; h < BOARD_HEIGHT; h++) {
                    let newTr = document.createElement('tr')
                    for (let w = 0; w < BOARD_WIDTH; w++) {
                        gameBoard[w][h] = {
                            x: w,
                            y: h,
                            id: w + "x" + h,
                            number: 0,
                            type: 0,
                            tag: saper.NONE,
                            view: saper.NOT_VIEWED
                        };
                        let newTh = document.createElement('th')
                        newTh.id = w + "x" + h;
                        newTh.style.backgroundImage = "url(field.png)"

                        newTh.onclick = () => saper.onFieldClick(w, h)

                        newTh.addEventListener('contextmenu', (ev) => saper.onRightClick(ev, w, h), false);
                        newTr.appendChild(newTh)

                    }
                    board.appendChild(newTr);
                }
            },
            genBoard: () => {
                saper.createTableElement();
                saper.genMines();
                saper.refreshScore();
            },
            genMines: () => {
                for (let m = 0; m < NUMBER_OF_MINES; m++) {
                    let toggle = true;
                    do {
                        let w = saper.drawWidth();
                        let h = saper.drawHeight();
                        if (gameBoard[w][h].type === saper.CLEAR_FIELD) {
                            gameBoard[w][h].type = saper.MINE;
                            toggle = false;
                            document.getElementById(gameBoard[w][h].id).style.backgroundColor = 'red'
                        }
                    } while (toggle)
                }
                saper.setNumbers();
            },
            onRightClick: (ev, w, h) => {
                ev.preventDefault();

                if (saper.gameLock && gameBoard[w][h].view === saper.NOT_VIEWED) {
                    let field = saper.getField(w, h)
                    switch (gameBoard[w][h].tag) {
                        case saper.NONE:
                            field.style.backgroundImage = "url(flag.png)";
                            gameBoard[w][h].tag = saper.FLAG
                            break;
                        case saper.FLAG:
                            field.style.backgroundImage = "url(qm.png)";
                            gameBoard[w][h].tag = saper.QM;
                            break;
                        case saper.QM:
                            field.style.backgroundImage = "url(field.png)";
                            gameBoard[w][h].tag = saper.NONE;
                            break;
                    }
                    saper.refreshScore();
                }
            },
            onFieldClick: (w, h) => {
                if (saper.gameLock && gameBoard[w][h].tag === saper.NONE) {
                    if (gameBoard[w][h].number === saper.CLEAR_FIELD) {
                        saper.checkFieldsAround(w, h)
                    } else {
                        if (gameBoard[w][h].view === saper.NOT_VIEWED) {
                            let field = saper.getField(w, h);
                            if (gameBoard[w][h].type === saper.MINE) {
                                saper.showBombs();

                                saper.gameLock = false;
                                saper.getElement("msg").innerText = "PRZEGRALES :(, czas: " + saper.currentTime;
                                clearInterval(saper.timer)
                            } else {
                                field.style.backgroundImage = "";
                                field.innerHTML = gameBoard[w][h].number;
                                gameBoard[w][h].view = saper.VIEWED;
                            }
                        }
                    }

                    if (saper.sumViewed() === saper.area - NUMBER_OF_MINES) {
                        saper.gameLock = false;
                        saper.getElement("msg").innerText = "WYGRALES!!!!, czas: " + saper.currentTime
                        clearInterval(saper.timer)
                        saper.showBombs()
                    }
                }
            },
            checkFieldsAround: (w, h) => {
                for (let w2 = w - 1; w2 <= w + 1; w2++) {
                    for (let h2 = h - 1; h2 <= h + 1; h2++) {
                        if (w2 >= 0 && h2 >= 0 && w2 < BOARD_HEIGHT && h2 < BOARD_WIDTH) {
                            if (gameBoard[w2][h2].view === saper.NOT_VIEWED) {
                                gameBoard[w2][h2].view = saper.VIEWED;
                                saper.getField(w2, h2).style.backgroundImage = "";
                                if (gameBoard[w2][h2].number > 0) {
                                    saper.getField(w2, h2).innerHTML = gameBoard[w2][h2].number;
                                } else {
                                    saper.checkFieldsAround(w2, h2)
                                }
                            }
                        }
                    }
                }
            },
            showBombs: () => {
                for (let w = 0; w < BOARD_HEIGHT; w++) {
                    for (let h = 0; h < BOARD_WIDTH; h++) {
                        if (gameBoard[w][h].type === saper.MINE) {
                            saper.getField(w, h).style.backgroundImage = "url(pbomb.png)";
                        }
                    }
                }
            },
            sumViewed: () => {
                let counter = 0;
                for (let w = 0; w < BOARD_HEIGHT; w++) {
                    for (let h = 0; h < BOARD_WIDTH; h++) {
                        if (gameBoard[w][h].view === saper.VIEWED) {
                            counter++;
                        }
                    }
                }
                return counter;
            },
            sumTagged: () => {
                let counter = 0;
                for (let w = 0; w < BOARD_HEIGHT; w++) {
                    for (let h = 0; h < BOARD_WIDTH; h++) {
                        if (gameBoard[w][h].tag === saper.FLAG) {
                            counter++;
                        }
                    }
                }
                return NUMBER_OF_MINES - counter;
            },
            refreshScore: () => {
                saper.getElement("mines-counter").innerText = "Nieoznaczone bomby: " + saper.sumTagged();
            },
            setNumbers: () => {
                for (let w = 0; w < BOARD_WIDTH; w++) {
                    for (let h = 0; h < BOARD_HEIGHT; h++) {
                        gameBoard[w][h].number = saper.checkSquare(w, h);
                    }
                }
            },
            checkSquare: (w, h) => {
                let counter = 0;
                for (let w2 = w - 1; w2 <= w + 1; w2++) {
                    for (let h2 = h - 1; h2 <= h + 1; h2++) {
                        if (w2 >= 0 && h2 >= 0 && w2 < BOARD_HEIGHT && h2 < BOARD_WIDTH)
                            if (gameBoard[w2][h2].type === saper.MINE) {
                                counter++;
                            }
                    }
                }
                return counter;
            },
            refreshTimer: () => {
                let date = new Date(Date.now() - saper.startTime);
                let ms = date.getMilliseconds();
                if (ms < 100) {
                    ms = ms * 10;
                }
                saper.currentTime = date.getMinutes() + ":" + date.getSeconds() + "." + ms;
                saper.getElement("msg").innerText = saper.currentTime;
            },
            getElement: (name) => {
                return document.getElementById(name);
            },
            drawWidth: () => {
                return Math.floor((Math.random() * BOARD_WIDTH));
            },
            drawHeight: () => {
                return Math.floor((Math.random() * BOARD_HEIGHT));
            },
            getField: (x, y) => {
                return document.getElementById(x + "x" + y);
            }
        }

        window.onload = () => {
            document.getElementById("valuesButton").onclick = saper.startGame;
        }
    </script>
</head>
<body>
<div id="values">
    <label>
        <h2 style="text-align:center;">Wysokosc:</h2>
        <input id="w" type="number" min="0" value="10">
    </label>
    <label>
        <h2 style="text-align:center;">Szerokosc:</h2>
        <input id="h" type="number" min="0" value="10">
    </label>
    <label>
        <h2 style="text-align:center;">Ilosc bomb:</h2>
        <input id="mines" type="number" min="0" value="15">
    </label>
    <br>
    <button id="valuesButton">Generuj</button>
</div>
<div id="main">
    <h2 id="msg" style="text-align:center;"></h2>
    <table id="board"></table>
    <h2 id="mines-counter" style="text-align:center;"></h2>
    <div id="test"></div>
</div>
</body>
</html>
