<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step 3</title>

    <style>
        td {
            border: black 1px solid;
        }

        tr {
            height: 40px;
            border: black 1px solid;
        }

        th {
            width: 40px;
            border: black 1px solid;
        }

        #players-board {
            position: relative;
            left: 350px;
        }

        #ships-list {
            position: absolute;
            left: 100px;
            top: 8px;
        }
    </style>

    <script>
        const VERTICAL = true;
        const boardSize = 10;
        let selectedShip = 0;
        let boardArray = Array.from(Array(boardSize), () => new Array(boardSize))
        let ships = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
        let shipDir = VERTICAL;

        let x = -1;
        let y = -1

        window.onload = function () {
            if (boardSize >= 10) {
                boardArray = fillArrayWithZeros(boardArray);

                renderBoard();

                renderShipList();
            }
        }

        function fillArrayWithZeros(array) {
            for (let i = 0; i < array.length; i++) {
                for (let j = 0; j < array.length; j++) {
                    array[i][j] = 0;
                }
            }
            return array;
        }

        function clearBoard() {
            for (let x = 0; x < boardSize; x++) {
                for (let y = 0; y < boardSize; y++) {
                    if (boardArray[x][y] === 1) {
                        setFieldState(x, y, "blue")
                    } else {
                        setFieldState(x, y, "white")
                    }
                }
            }
        }

        function placeShip(x, y) {
            if (isPositionValid(x, y) === "0") {
                renderShip(x, y, shipDir, ships[selectedShip], "blue");
                ships.splice(selectedShip, 1);
                selectedShip = -1;
                renderShipList();
            }
        }

        function renderBoard() {
            let board = document.getElementById('players-board');
            for (let x = 0; x < boardSize; x++) {
                let newTr = document.createElement('tr')
                for (let y = 0; y < boardSize; y++) {
                    let newTh = document.createElement("th")
                    newTh.id = x + "x" + y;
                    newTh.onmouseover = () => onMouseOver(x, y);

                    newTh.addEventListener('contextmenu', function (ev) {
                        ev.preventDefault();
                        shipDir = !shipDir;

                        onMouseOver(x, y);
                    }, false);

                    newTh.onclick = () => placeShip(x, y);

                    newTr.appendChild(newTh)
                }
                board.appendChild(newTr);
            }
            board.onmouseleave = () => clearBoard();
        }

        function onMouseOver(x, y) {
            clearBoard();
            if (shipDir === VERTICAL) {
                if (x + ships[selectedShip] > boardSize)
                    x = x - (x + ships[selectedShip] - boardSize)
            } else {
                if (y + ships[selectedShip] > boardSize)
                    y = y - (y + ships[selectedShip] - boardSize)
            }

            if (isPositionValid(x, y) === "0")
                renderShip(x, y, shipDir, ships[selectedShip], "green")
            else
                renderShip(x, y, shipDir, ships[selectedShip], "red")

        }

        function renderShipList() {
            let shipsList = document.getElementById('ships-list');
            shipsList.innerHTML = '';

            for (let s = 0; s < ships.length; s++) {
                let newShip = document.createElement('table');
                newShip.id = "ship=" + s;
                newShip.style.marginBottom = "20px";
                let newTr = document.createElement('tr');

                if (s === selectedShip)
                    newTr.style.backgroundColor = "blue";

                newShip.onmouseover = () => {
                    if (selectedShip !== s)
                        newTr.style.backgroundColor = "red";
                }

                newShip.onmouseleave = () => {
                    if (selectedShip !== s)
                        newTr.style.backgroundColor = "white";
                }

                newShip.onclick = () => {
                    newTr.style.backgroundColor = "blue";
                    selectedShip = s;
                    clearShips(selectedShip);
                }

                for (let i = 0; i < ships[s]; i++) {
                    newTr.appendChild(document.createElement('th'));
                }
                newShip.appendChild(newTr);
                shipsList.appendChild(newShip);
            }
        }

        function clearShips(ship) {
            for (let i = 0; i < ships.length; i++) {
                if (i !== ship) {
                    document.getElementById("ship=" + i).getElementsByTagName('tr')[0].style.backgroundColor = "white";
                }
            }
        }

        function isPositionValid(x, y) {
            let result;

            if (shipDir === VERTICAL) {
                result = checkPositionsAround(x, y, ships[selectedShip] + 1, 2)
            } else {
                result = checkPositionsAround(x, y, 2, ships[selectedShip] + 1)
            }
            return result;
        }

        function checkPositionsAround(x, y, size1, size2) {
            for (let i = -1; i < size1; i++) {
                for (let k = -1; k < size2; k++) {
                    if (x + i < 0 || y + k < 0)
                        continue;

                    if (x + i > boardSize || y + k > boardSize) {
                        return "1"
                    }

                    if (x + i < 10 && y + k < 10 && getStateOfField(boardArray, x + i, y + k))
                        return "2";
                }
            }
            return "0";
        }

        function renderShip(x, y, dir, size, color) {
            for (let i = 0; i < size; i++) {
                let tempX = x;
                let tempY = y;
                if (dir === VERTICAL)
                    tempX = x + i;
                else
                    tempY = y + i

                setFieldState(tempX, tempY, color);
                if (color === "blue")
                    boardArray[tempX][tempY] = 1;
            }
        }

        function setFieldState(x, y, color) {
            document.getElementById(x + "x" + y).style.backgroundColor = color;
        }

        function getStateOfField(array, x, y) {
            return array[x][y] === 1;
        }








        function generateBoard() {
            let ships = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1]

            let board = Array.from(Array(boardSize), () => new Array(boardSize))

            if (boardSize >= 10) {
                board = fillArrayWithZeros(board)

                renderComputerBoard(board)


                for (let i = 0; i < 10; i++) {
                    let result = "0"
                    do {
                        result = placeShip(board, ships[i], drawDirection(), drawCoordinate(), drawCoordinate())
                    } while (result !== "0");
                }
            }
        }

        function renderComputerBoard() {
            for (let i = 0; i < boardSize; i++) {
                let newTr = document.createElement('tr')
                for (let k = 0; k < boardSize; k++) {
                    let newTh = document.createElement("th")
                    newTh.id = i + "x" + k;
                    newTr.appendChild(newTh)
                }
                document.getElementById("computers-board").appendChild(newTr);
            }
        }

        function placeShip(board, size, dir, x, y) {
            let result = "0";
            if (doesShipFit(x, y, size, dir)) {
                result = "1";
            }

            if (result !== "0")
                return result;

            if (dir === VERTICAL) {
                result = isPositionValid(x, y, size + 1, 2)
            } else {
                result = isPositionValid(x, y, 2, size + 1)
            }

            if (result !== "0")
                return result;

            renderShip(x, y, dir, size);
            return result;
        }

        function doesShipFit(x, y, size, dir) {
            if (dir === VERTICAL) {
                return x + size > boardSize;
            } else {
                return y + size > boardSize;
            }
        }

        function renderShip(x, y, dir, size) {
            for (let i = 0; i < size; i++) {
                if (dir === VERTICAL) {
                    setFieldState(x + i, y, true);
                } else {
                    setFieldState(x, y + i, true);
                }
            }
        }

        function setFieldState(x, y, state) {
            let obj = document.getElementById(x + "x" + y).style;
            if (state) {
                obj.backgroundColor = "black";
            } else {
                obj.backgroundColor = "white";
            }
        }

        function drawCoordinate() {
            return Math.floor((Math.random() * 10));
        }

        function drawDirection() {
            return Math.random() < 0.5;
        }

    </script>
</head>
<body>
<div id="ships-list">

</div>

<table id="players-board">

</table>

<table id="computers-board">

</table>
</body>
</html>
