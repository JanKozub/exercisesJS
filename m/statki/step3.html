<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step 3</title>

    <style>
        td {
            border: black 1px solid;
        }

        tr {
            height: 40px;
            border: black 1px solid;
        }

        th {
            width: 40px;
            border: black 1px solid;
        }

        #player-board {
            position: relative;
            left: 350px;
            top: 50px;
        }

        #computers-board {
            position: absolute;
            left: 900px;
            top: 58px;
        }

        #ships-list {
            position: absolute;
            left: 100px;
            top: 58px;
        }

        #player-label {
            position: absolute;
            left: 520px;
            top: -30px;
            font-size: 40px;
        }

        #computer-label {
            position: absolute;
            left: 1020px;
            top: -30px;
            font-size: 40px;
        }

        #start-button {
            width: 400px;
            height: 100px;
            position: absolute;
            top: 600px;
            left: 600px;
        }

        .dot {
            height: 10px;
            width: 10px;
            background-color: black;
            border-radius: 50%;
            display: inline-block;
        }
    </style>

    <script>
        const VERTICAL = true;
        const PLAYER = "p";
        const COMPUTER = "c";
        const boardSize = 10;

        let selectedShip = 0;
        let playerBoardArray = Array.from(Array(boardSize), () => new Array(boardSize));
        let computerBoardArray = Array.from(Array(boardSize), () => new Array(boardSize));
        let playerShips = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
        let destroyedShips = [];
        let shipDir = VERTICAL;

        let scores = []

        let isGameStarted = false;
        let lockShoot = false;

        window.onload = function () {
            if (boardSize >= 10) {
                restartGame();

                renderPlayerBoard();
                renderComputerBoard();


                document.getElementById("start-button").onclick = () => {
                    if (playerShips.length === 0 && !isGameStarted) {
                        generateComputerBoard();
                        isGameStarted = true;
                    } else {
                        if (!isGameStarted)
                            alert("Umiesc wszystkie statki")
                    }
                }

                document.getElementById("player-board").onclick = () => {
                    if (isGameStarted) {
                        alert("To nie twoja plansza!")
                    }
                }
            }
        }

        function fillArrayWithZeros(array) {
            for (let i = 0; i < array.length; i++) {
                for (let j = 0; j < array.length; j++) {
                    array[i][j] = 0;
                }
            }
            return array;
        }

        function clearBoard(array) {
            for (let x = 0; x < boardSize; x++) {
                for (let y = 0; y < boardSize; y++) {
                    let color = "white"
                    if (array[x][y] === 1) {
                        color = "blue"
                    }

                    if (document.getElementById("c=0x0") !== null
                        && document.getElementById("p=0x0") !== null) {
                        if (array === computerBoardArray) {
                            setFieldState(COMPUTER, x, y, color)
                            document.getElementById("c=" + x + "x" + y).innerText = ""
                        } else {
                            setFieldState(PLAYER, x, y, color)
                        }
                    }
                }
            }
        }

        function generateComputerBoard() {
            let ships = [40, 30, 31, 20, 21, 22, 10, 11, 12, 13]

            fillArrayWithZeros(computerBoardArray);
            clearBoard(computerBoardArray);

            if (boardSize >= 10) {
                for (let i = 0; i < 10; i++) {
                    let result;
                    do {
                        result = placeShip(COMPUTER, ships[i], drawCoordinate(), drawCoordinate(), drawDirection())
                    } while (!result);
                }
            }
        }

        function renderPlayerBoard() {
            let board = document.getElementById('player-board');
            for (let x = 0; x < boardSize; x++) {
                let newTr = document.createElement('tr')
                for (let y = 0; y < boardSize; y++) {
                    let newTh = document.createElement('th')
                    newTh.id = PLAYER + "=" + x + "x" + y;
                    newTh.onmouseover = () => onMouseOver(x, y);

                    newTh.addEventListener('contextmenu', function (ev) {
                        ev.preventDefault();
                        shipDir = !shipDir;

                        onMouseOver(x, y);
                    }, false);

                    newTh.onclick = () => placeShip(PLAYER, playerShips[selectedShip], x, y, shipDir);

                    newTr.appendChild(newTh)
                }
                board.appendChild(newTr);
            }
            board.onmouseleave = () => clearBoard(playerBoardArray);
        }

        function placeShip(board, id, x, y, direction) {
            let size = id
            if (board === COMPUTER)
                size = Math.floor(id / 10)

            if (!isPositionValid(getBoardArr(board), size, x, y, direction))
                return false;

            if (board === PLAYER) {
                renderShip(board, x, y, direction, size, size, "blue");
                playerShips.splice(selectedShip, 1);
                selectedShip = 0;
                if (playerShips.length !== -1) {
                    renderShipList();
                }
            } else {
                renderShip(board, x, y, direction, size, id, "black");
            }
            return true;
        }

        function renderComputerBoard() {
            for (let x = 0; x < boardSize; x++) {
                let newTr = document.createElement('tr')
                for (let y = 0; y < boardSize; y++) {
                    let newTh = document.createElement("th")
                    newTh.id = COMPUTER + "=" + x + "x" + y;
                    newTh.onclick = () => {
                        if (isGameStarted && !lockShoot && computerBoardArray[x][y] >= 0) {
                            if (!isGameEnded()) {
                                lockShoot = true;
                                if (computerBoardArray[x][y] !== 0) {
                                    newTh.innerHTML = "âœ–";
                                    newTh.style.backgroundColor = "red";
                                    let value = computerBoardArray[x][y];
                                    scores.push(value)
                                    isShipCompleted(x, y);
                                    computerBoardArray[x][y] = value * -1;
                                } else {
                                    newTh.innerHTML = "<span class=\"dot\"></span>";
                                    computerBoardArray[x][y] = -5;
                                }

                                if (isGameEnded()) {
                                    alert("WYGRALES!!!")

                                    restartGame();
                                } else {
                                    setTimeout(() => computerShoot(), 200);
                                }
                            }
                        }
                    }
                    newTr.appendChild(newTh)
                }
                document.getElementById("computers-board").appendChild(newTr);
            }
        }

        function isGameEnded() {
            return destroyedShips.length === 10;
        }

        function restartGame() {
            playerBoardArray = fillArrayWithZeros(playerBoardArray);
            computerBoardArray = fillArrayWithZeros(computerBoardArray);

            renderShipList();

            clearBoard(playerBoardArray)
            clearBoard(computerBoardArray)
        }

        function isShipCompleted(x, y) {
            let num = checkPositionsAround(computerBoardArray, x, y, 2, 2);
            if (howManyElementsArrayContains(scores, num) === Math.floor(num / 10)) {
                destroyedShips.push(num)
                console.log(destroyedShips)
            }
        }

        function computerShoot() {
            let x;
            let y;
            do {
                x = drawCoordinate();
                y = drawCoordinate();
            } while (playerBoardArray[x][y] === 1)

            setFieldState(PLAYER, x, y, "red")
            lockShoot = false;
        }

        function onMouseOver(x, y) {
            clearBoard(playerBoardArray);
            if (shipDir === VERTICAL) {
                if (x + playerShips[selectedShip] > boardSize)
                    x = x - (x + playerShips[selectedShip] - boardSize)
            } else {
                if (y + playerShips[selectedShip] > boardSize)
                    y = y - (y + playerShips[selectedShip] - boardSize)
            }

            if (isPositionValid(playerBoardArray, playerShips[selectedShip], x, y, shipDir))
                renderShip(PLAYER, x, y, shipDir, playerShips[selectedShip], 0, "green")
            else
                renderShip(PLAYER, x, y, shipDir, playerShips[selectedShip], 0, "red")

        }

        function renderShipList() {
            let shipsList = document.getElementById('ships-list');
            shipsList.innerHTML = '';

            for (let s = 0; s < playerShips.length; s++) {
                let newShip = document.createElement('table');
                newShip.id = "ship=" + s;
                newShip.style.marginBottom = "20px";
                let newTr = document.createElement('tr');

                if (s === selectedShip)
                    newTr.style.backgroundColor = "blue";

                newShip.onmouseover = () => {
                    if (selectedShip !== s)
                        newTr.style.backgroundColor = "red";
                }

                newShip.onmouseleave = () => {
                    if (selectedShip !== s)
                        newTr.style.backgroundColor = "white";
                }

                newShip.onclick = () => {
                    newTr.style.backgroundColor = "blue";
                    selectedShip = s;
                    clearShips(selectedShip);
                }

                for (let i = 0; i < playerShips[s]; i++) {
                    newTr.appendChild(document.createElement('th'));
                }
                newShip.appendChild(newTr);
                shipsList.appendChild(newShip);
            }
        }

        function clearShips(ship) {
            for (let i = 0; i < playerShips.length; i++) {
                if (i !== ship) {
                    document.getElementById("ship=" + i).getElementsByTagName('tr')[0].style.backgroundColor = "white";
                }
            }
        }

        function isPositionValid(boardArr, ship, x, y, dir) {
            if (dir === VERTICAL) {
                return checkPositionsAround(boardArr, x, y, ship + 1, 2) <= 0;
            } else {
                return checkPositionsAround(boardArr, x, y, 2, ship + 1) <= 0;
            }
        }

        function checkPositionsAround(boardArr, x, y, size1, size2) {
            for (let i = -1; i < size1; i++) {
                for (let k = -1; k < size2; k++) {
                    if (x + i < 0 || y + k < 0)
                        continue;

                    if (x + i > boardSize || y + k > boardSize) {
                        return 1;
                    }

                    if (x + i < boardSize && y + k < boardSize) {
                        let fieldNum = boardArr[x + i][y + k];

                        if (fieldNum > 0) {
                            return fieldNum;
                        }
                    }
                }
            }
            return 0;
        }

        function renderShip(board, x, y, dir, size, id, color) {
            for (let i = 0; i < size; i++) {
                let tempX = x;
                let tempY = y;
                if (dir === VERTICAL)
                    tempX = x + i;
                else
                    tempY = y + i

                setFieldState(board, tempX, tempY, color);
                if (color === "blue")
                    playerBoardArray[tempX][tempY] = 1;
                else
                    computerBoardArray[tempX][tempY] = id;
            }
        }

        function setFieldState(board, x, y, color) {
            document.getElementById(board + "=" + x + "x" + y).style.backgroundColor = color;
        }

        function getBoardArr(board) {
            if (board === PLAYER)
                return playerBoardArray;
            else
                return computerBoardArray;
        }

        function drawCoordinate() {
            return Math.floor((Math.random() * 9));
        }

        function drawDirection() {
            return Math.random() < 0.5;
        }

        function howManyElementsArrayContains(array, element) {
            let counter = 0;
            for (let i = 0; i < array.length; i++) {
                if (array[i] === element) {
                    counter++;
                }
            }
            return counter;
        }
    </script>
</head>
<body>
<p id="player-label">GRACZ</p>
<div id="ships-list"></div>
<table id="player-board"></table>

<p id="computer-label">KOMPUTER</p>
<table id="computers-board"></table>

<button id="start-button">Start</button>
</body>
</html>
